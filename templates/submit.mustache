{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>;.
}}

<div class="testimonial-header">
    <h2>{{#str}}shareexperience, local_testimonial{{/str}}</h2>
    <p>{{#str}}opinion, local_testimonial{{/str}}</p>
</div>
<div class="testimonial-container" id="testimonial-container">
    <input type="hidden" id="testimonial-token" value="{{ token }}">
    <h3>{{#str}}leave, local_testimonial{{/str}}</h3>
    <p>{{#str}}choose, local_testimonial{{/str}}</p>
    <div class="btn-group">
        <button id="videoBtn" class="btn btn-primary">{{#str}}video, local_testimonial{{/str}}</button>
        <button id="textBtn" class="btn btn-light">{{#str}}text, local_testimonial{{/str}}</button>
    </div>
    <div class="videobox" id="videobox" style="display: none;">
        <h4>{{#str}}record, local_testimonial{{/str}}</h4>
        <div class="video-preview" id="camera-preview">
            <video id="video" autoplay muted playsinline></video>
        </div>
        <button id="startBtn" class="btn btn-danger">{{#str}}recording, local_testimonial{{/str}}</button>
        <button id="stopBtn" class="btn btn-secondary" style="display: none;">{{#str}}stop, local_testimonial{{/str}}</button>
        <button id="cancelVideoBtn" class="btn btn-secondary">{{#str}}cancel, local_testimonial{{/str}}</button>
    </div>
    <div class="previewbox" id="previewbox" style="display: none;">
        <h4>{{#str}}preview, local_testimonial{{/str}}</h4>
        <video id="previewVideo" controls></video><br>
        <button id="saveVideoBtn" class="btn btn-primary">{{#str}}save, local_testimonial{{/str}}</button>
        <button id="retakeBtn" class="btn btn-secondary">{{#str}}retake, local_testimonial{{/str}}</button>
    </div>
    <div class="textform" id="textform" style="display: none;">
        <h4>{{#str}}writetestimonial, local_testimonial{{/str}}</h4>
        <textarea id="testimonialText" name="testimonial_text" class="form-control" rows="5" placeholder="Type your testimonial here..."></textarea>
        <br>
        <button id="cancelTextBtn" class="btn btn-secondary">{{#str}}cancel, local_testimonial{{/str}}</button>
        <button id="submitTextBtn" class="btn btn-primary">{{#str}}submittestimonial, local_testimonial{{/str}}</button>
    </div>
</div>
<div id="thank-you-message" class="alert alert-success" style="display: none; text-align: center;">
    <h2>{{#str}}thankyoufeedback, local_testimonial{{/str}}</h2>
    <p>{{#str}}thankyoutext, local_testimonial{{/str}}</p>
</div>
<script>
    const videoBtn = document.getElementById("videoBtn");
    const textBtn = document.getElementById("textBtn");
    const videobox = document.getElementById("videobox");
    const textform = document.getElementById("textform");
    const previewbox = document.getElementById("previewbox");
    const videoElement = document.getElementById("video");
    const previewVideoElement = document.getElementById("previewVideo");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const cancelVideoBtn = document.getElementById("cancelVideoBtn");
    const saveVideoBtn = document.getElementById("saveVideoBtn");
    const retakeBtn = document.getElementById("retakeBtn");    
    const testimonialText = document.getElementById("testimonialText");
    const submitTextBtn = document.getElementById("submitTextBtn");
    const cancelTextBtn = document.getElementById("cancelTextBtn");
    const tokenInput = document.getElementById("testimonial-token");
    const testimonialContainer = document.getElementById("testimonial-container");
    const thankYouMessage = document.getElementById("thank-you-message");
    let stream;
    let mediaRecorder;
    let recordedChunks = [];
    let recordedBlob;
    videoBtn.addEventListener("click", () => {
        videobox.style.display = "block";
        textform.style.display = "none";
        previewbox.style.display = "none";
        openCamera();
    });
    textBtn.addEventListener("click", () => {
        textform.style.display = "block";
        videobox.style.display = "none";
        previewbox.style.display = "none";
        stopCamera();
    });
    function showSuccessMessage() {
        testimonialContainer.style.display = "none";
        thankYouMessage.style.display = "block";
        stopCamera();
    }
    async function openCamera() {
        try {
            if (!stream) {
                 stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            }
            videoElement.srcObject = stream;
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
        } catch (err) {
            console.error("Camera Error:", err);
            alert("Could not access the camera. Please check browser permissions.");
        }
    }
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }
    startBtn.addEventListener("click", () => {
        if (stream) {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.start();
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';            
            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };
            mediaRecorder.onstop = () => {
                recordedBlob = new Blob(recordedChunks, { type: "video/webm" });
                const previewUrl = URL.createObjectURL(recordedBlob);
                previewVideoElement.src = previewUrl;
                videobox.style.display = "none";
                previewbox.style.display = "block";
            };
        } else {
            alert("Camera not initialized. Please allow camera access.");
        }
    });
    stopBtn.addEventListener("click", () => {
        if (mediaRecorder) mediaRecorder.stop();
    });
    retakeBtn.addEventListener("click", () => {
        if (previewVideoElement.src) URL.revokeObjectURL(previewVideoElement.src);
        previewbox.style.display = "none";
        videobox.style.display = "block";
        openCamera();
    });
    cancelVideoBtn.addEventListener("click", () => {
        stopCamera();
        videobox.style.display = "none";
    });
    saveVideoBtn.addEventListener("click", () => {
       if (recordedBlob) {
            const reader = new FileReader();
            reader.readAsDataURL(recordedBlob);
            reader.onloadend = function() {
                const base64data = reader.result;
                const token = tokenInput.value;
                const filename = `video_testimonial_${Date.now()}.webm`;
                const postData = { fname: filename, data: base64data, type: 'video' };
                fetch(`save_testimonial.php?token=${token}`, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        throw new Error(data.message || 'An unknown error occurred on the server.');
                    }
                    console.log("Server response:", data);
                    showSuccessMessage();
                })
                .catch(err => {
                    console.error("Upload Error:", err);
                    alert("Upload failed: " + err.message);
                });
            }
       }
    });
    submitTextBtn.addEventListener("click", () => {
        const textValue = testimonialText.value.trim();
        if (textValue === "") {
            alert("Please write something.");
            return;
        }
        const token = tokenInput.value;
        const filename = `text_testimonial_${Date.now()}.txt`;
        const base64data = 'data:text/plain;base64,' + btoa(unescape(encodeURIComponent(textValue)));
        const postData = { fname: filename, data: base64data, type: 'text' };
        fetch(`save_testimonial.php?token=${token}`, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                throw new Error(data.message || 'An unknown error occurred on the server.');
            }
            console.log("Server response:", data);
            showSuccessMessage();
        })
        .catch(err => {
            console.error("Submit Error:", err);
            alert("Submission failed: " + err.message);
        });
    });
    cancelTextBtn.addEventListener("click", () => {
        textform.style.display = "none";
    });
</script>